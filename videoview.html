<html>
    <head>
        <meta charset="utf-8">
        <title>videoviewer</title>

        <style>
            *{
                margin: 0px;
            }

            body {
                background-color: rgb(25, 25, 25);
                color: aliceblue;
            }

            .container {
                position: relative;
            }

            .container video {
                position: relative;
                width: 100%;
                height: auto;
	            vertical-align: middle;
                z-index: 0;
            }

            .overlay {
                position:absolute;
                left: 2%;
                top: 2%;
                z-index: 1;
            }
            
            .overlay #label1 {
                background-color: rgba(0, 0, 0, 0.171);
            }

        </style>
    </head>
    <body oncontextmenu="return false">

        <div class="container">
            <video id="player" buffered> </video>

            <div class="overlay">
                <h1 id="label1"></h1>
            </div>
        </div>
        
        <script>
            
            const label1 = document.getElementById("label1");
            let delayedoffTimer = undefined;
            
            function setLabelText(msg) {
                if(delayedoffTimer != undefined) clearTimeout(delayedoffTimer);
                
                label1.innerText = msg;
                label1.style.visibility="visible";
                
                delayedoffTimer = setTimeout(() => {
                    label1.style.visibility="hidden";
                    delayedoffTimer = undefined;
                },1000);

            }

            const smallmove = 1.0;
            const normalmove = 5.0;
            const bigmove = 30.0;

            const urlStr = window.location.href;
            const url = new URL(urlStr);
            const urlParams = url.searchParams;
            const path = urlParams.get('p');


            function pauseplay() {
                if(player.paused) {
                    player.play();
                    setLabelText("play");
                }
                else {
                    player.pause();
                    setLabelText("pause");
                }
            }

            function volumncontrol(updown)
            {
                const unit = 0.05;
                let volumnset = player.volume;
                if(updown) {
                    if(volumnset + unit > 1.0)
                        volumnset = 1.0;
                    else
                        volumnset += unit;
                }
                else {
                    if(volumnset - unit < 0)
                        volumnset = 0;
                    else
                        volumnset -= unit;
                }

                player.volume = volumnset;
                
                setLabelText(`volumn: ${Math.round(player.volume*100)}%`);
            }

            function onKeydown(param)
            {
                console.log(param.key);

                switch(param.key){
                    case ' ':
                        pauseplay();
                        break;
                    case 'f':
                        {
                            if (!document.fullscreenElement) {
                                document.documentElement.requestFullscreen()
                            } else {
                                if (document.exitFullscreen)
                                    document.exitFullscreen()
                            }
                        }
                        break;
                    case "ArrowUp":
                        volumncontrol(true);
                        break;
                    case "ArrowDown":
                        volumncontrol(false);
                        break;
                    case "ArrowRight":
                        {
                            let move;
                            let moveunit;
                            
                            if(param.shiftKey)
                                moveunit = normalmove;
                            else if(param.ctrlKey)
                                moveunit = smallmove;
                            else
                                moveunit = bigmove;

                            move = player.currentTime + moveunit;
                            if(move >= player.duration) move = player.duration - 1.0;
                            player.currentTime = move;

                            const progress = (player.currentTime / player.duration * 100).toFixed(2);

                            setLabelText(`+ ${moveunit}s (${progress}%)`);
                        }
                        break;
                    case "ArrowLeft":
                        {
                            let move;
                            let moveunit;
                            
                            if(param.shiftKey)
                                moveunit = normalmove;
                            else if(param.ctrlKey)
                                moveunit = smallmove;
                            else
                                moveunit = bigmove;

                            move = player.currentTime - moveunit;
                            if(move < 0) move = 0;
                            player.currentTime = move;   

                            const progress = (player.currentTime / player.duration * 100).toFixed(2);

                            setLabelText(`- ${moveunit}s (${progress}%)`);
                        }
                        break;
                }
            }

            let leftmouse_movestarted = false;
            let leftmousedowned = false;
            let leftmousedownpos = 0;
            let leftcancelnextclick = false;

            let rightmouse_movestarted = false;
            let rightmousedowned = false;
            let rightmousedownpos = 0;
            let rightcancelnextclick = false;

            let intervalvideoposapplyier = undefined;
            let positionscrollstart;
            let positionscrollcurr;
            let startvideoposition;
            
            document.addEventListener("click", (param) => {

                switch(param.button) {
                    case 0:
                        if(leftcancelnextclick) leftcancelnextclick = false;
                        else pauseplay();
                        break;
                    case 1:

                        break;
                    case 2:
                        if(rightcancelnextclick) rightcancelnextclick = false;
                        else {
                            console.log("right click");
                        }
                        break;
                }
            });

            document.addEventListener("mousedown", (param) => {

                switch(param.button) {
                    case 0: // left
                        leftmousedowned = true;
                        leftmouse_movestarted = true;
                        leftmousedownpos = param.x;
                        break;
                    
                    case 1: // middle

                        break;
                    
                    case 2: // right
                        rightmousedowned = true;
                        rightmouse_movestarted = true;
                        rightmousedownpos = param.x
                        break;
                }
                
            });
            
            document.addEventListener("mouseup", (param) => {
                
                switch(param.button) {
                    case 0: // left
                        {
                            leftmousedowned = false;
                            if(intervalvideoposapplyier != undefined)
                            {
                                clearTimeout(intervalvideoposapplyier);
                                intervalvideoposapplyier = undefined;
                                
                                player.currentTime = startvideoposition + positionscrollcurr;
                                const progress = (player.currentTime / player.duration * 100).toFixed(2);
                                setLabelText(`moving - ${progress}% (${Math.round((player.currentTime - startvideoposition))}s)`);

                                player.play();
                            }
                        }
                        break;
                    
                    case 1: // middle

                        break;
                    
                    case 2: // right
                        {
                            rightmousedowned = false;
                        }
                        break;
                }

            });
            

            let positionscrollcurr_past = -1;
            let positionscroll_past = -1;

            document.addEventListener("mousemove", (param) => {

                if(leftmousedowned) {
                    leftcancelnextclick = true;

                    let diff = param.x - leftmousedownpos;
                    const scroll_range = 1000;
                    if(diff > scroll_range) diff = scroll_range;

                    diff = Math.round(diff);

                    const maxpushduration = 180.0 // second
                    let positionscroll = Math.round(diff / scroll_range * maxpushduration);

                    const min_seeking_unit = 5.0;

                    positionscroll /= min_seeking_unit;
                    positionscroll = Math.round(positionscroll);
                    positionscroll *= min_seeking_unit;
                    positionscroll = Math.round(positionscroll);

                    if(leftmouse_movestarted)
                    {
                        leftmouse_movestarted = false;

                        console.log(`leftmouse_movestarted`);

                        player.pause();
                        positionscrollstart = positionscroll;
                        startvideoposition = player.currentTime;

                        intervalvideoposapplyier = setInterval(() => {
                            if(positionscrollcurr != positionscrollcurr_past)
                            {
                                console.log(`intervalvideoposapplyier`);
                                player.currentTime = (startvideoposition+positionscrollcurr);
                                const progress = (player.currentTime / player.duration * 100).toFixed(2);
                                setLabelText(`moving - ${progress}% (${Math.round((player.currentTime - startvideoposition))}s)`);
                            }
                            positionscrollcurr_past = positionscrollcurr;
                        }, 500);
                    }

                    positionscrollcurr = positionscroll - positionscrollstart;


                }
                else if(rightmousedowned) {
                    rightcancelnextclick = true;
                    let diff = param.x - rightmousedownpos;
                    console.log(`right - ${diff}`);
                    
                    if(rightmouse_movestarted)
                    {
                        rightmouse_movestarted = false;
                    }

                }

            });

            if(path != null)
            {
                console.log(`path - ${path}`);
                player = document.getElementById("player");
                player.src = path;
                player.volume = 0.1;

                // var promise = player.play();

                // if(promise != undefined) {
                //     promise.then(_ => {
                //         console.log("promise returned Successed");
                //     }).catch(error => {
                //         console.log("promise returned failed");
                //     });
                // }

                window.addEventListener("keydown", onKeydown);
            }
            else
            {
                console.log(`${path} is null`);
            }

        </script>

    </body>
</html>