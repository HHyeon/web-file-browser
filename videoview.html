<html>
    <head>
        <meta charset="utf-8">
        <title>videoviewer</title>

        <style>
            *{
                margin: 0px;
            }

            body {
                background-color: rgb(25, 25, 25);
                color: aliceblue;
            }

            .container {
                position: relative;
            }

            .container video {
                position: relative;
                width: 100%;
                height: auto;
	            vertical-align: middle;
                z-index: 0;
            }

            .overlay {
                position:absolute;
                left: 2%;
                top: 2%;
                z-index: 1;
            }
            
            .overlay #label1 {
                background-color: rgba(0, 0, 0, 0.171);
            }

        </style>
    </head>
    <body>

        <div class="container">
            <video id="player" buffered> </video>

            <div class="overlay">
                <h1 id="label1"></h1>
            </div>
        </div>
        
        <script>

            const label1 = document.getElementById("label1");
            let delayedoffTimer = undefined;
            
            function setLabelText(msg) {
                if(delayedoffTimer != undefined) clearTimeout(delayedoffTimer);
                
                label1.innerText = msg;
                label1.style.visibility="visible";
                
                delayedoffTimer = setTimeout(() => {
                    label1.style.visibility="hidden";
                    delayedoffTimer = undefined;
                },1000);

            }

            const smallmove = 1.0;
            const normalmove = 5.0;
            const bigmove = 30.0;

            const urlStr = window.location.href;
            const url = new URL(urlStr);
            const urlParams = url.searchParams;
            const path = urlParams.get('p');


            function pauseplay() {
                if(player.paused) {
                    player.play();
                    setLabelText("play");
                }
                else {
                    player.pause();
                    setLabelText("pause");
                }
            }

            function volumncontrol(updown)
            {
                const unit = 0.05;
                let volumnset = player.volume;
                if(updown) {
                    if(volumnset + unit > 1.0)
                        volumnset = 1.0;
                    else
                        volumnset += unit;
                }
                else {
                    if(volumnset - unit < 0)
                        volumnset = 0;
                    else
                        volumnset -= unit;
                }

                player.volume = volumnset;
                
                setLabelText(`volumn: ${Math.round(player.volume*100)}%`);
            }

            function onKeydown(param)
            {
                // console.log(param.key);

                switch(param.key){
                    case ' ':
                        pauseplay();
                        break;
                    case 'f':
                        {
                            if (!document.fullscreenElement) {
                                document.documentElement.requestFullscreen()
                            } else {
                                if (document.exitFullscreen)
                                    document.exitFullscreen()
                            }
                        }
                        break;
                    case "ArrowUp":
                        volumncontrol(true);
                        break;
                    case "ArrowDown":
                        volumncontrol(false);
                        break;
                    case "ArrowRight":
                        {
                            let move;
                            let moveunit;
                            
                            if(param.shiftKey)
                                moveunit = smallmove;
                            else if(param.ctrlKey)
                                moveunit = bigmove;
                            else
                                moveunit = normalmove;

                            move = player.currentTime + moveunit;
                            if(move >= player.duration) move = player.duration - 1.0;
                            player.currentTime = move;

                            const progress = (player.currentTime / player.duration * 100).toFixed(2);

                            setLabelText(`+ ${moveunit}s (${progress}%)`);
                        }
                        break;
                    case "ArrowLeft":
                        {
                            let move;
                            let moveunit;
                            
                            if(param.shiftKey)
                                moveunit = smallmove;
                            else if(param.ctrlKey)
                                moveunit = bigmove;
                            else
                                moveunit = normalmove;

                            move = player.currentTime - moveunit;
                            if(move < 0) move = 0;
                            player.currentTime = move;   

                            const progress = (player.currentTime / player.duration * 100).toFixed(2);

                            setLabelText(`- ${moveunit}s (${progress}%)`);
                        }
                        break;
                }
            }

            let mousedowned_lowedge = false;
            let mousedowned = false;
            let mousedownpos = 0;
            let cancelnextclick = false;
            let intervalvideoposapplyier = undefined;
            let positionscrollstart;
            let positionscrollcurr;
            let startvideoposition;
            
            document.addEventListener("click", (param) => {
                if(cancelnextclick) {
                    cancelnextclick = false;
                    return;
                }
                pauseplay();
            });

            document.addEventListener("mousedown", (param) => {
                mousedowned = true;
                mousedowned_lowedge = true;
                mousedownpos = param.x;
            });
            
            document.addEventListener("mouseup", (param) => {
                mousedowned = false;
                if(intervalvideoposapplyier != undefined)
                {
                    clearTimeout(intervalvideoposapplyier);
                    intervalvideoposapplyier = undefined;
                    
                    player.currentTime = startvideoposition + positionscrollcurr;
                    const progress = (player.currentTime / player.duration * 100).toFixed(2);
                    setLabelText(`moving - ${progress}% (${Math.round((player.currentTime - startvideoposition))}s)`);

                    player.play();
                }
            });
            
            document.addEventListener("mousemove", (param) => {
                if(mousedowned) {
                    cancelnextclick = true;

                    let diff = param.x - mousedownpos;
                    const scrolllimit = 500;
                    if(diff > scrolllimit) diff = scrolllimit;
                    
                    diff /= 1;
                    diff = Math.round(diff);
                    diff *= 1;

                    const maxpushduration = 180.0 // second
                    const positionscroll = diff / scrolllimit * maxpushduration;

                    if(mousedowned_lowedge)
                    {
                        mousedowned_lowedge = false;
                        player.pause();
                        positionscrollstart = positionscroll;
                        startvideoposition = player.currentTime;

                        intervalvideoposapplyier = setInterval(() => {
                            if((startvideoposition+positionscrollcurr) != player.currentTime)
                            {
                                player.currentTime = (startvideoposition+positionscrollcurr);
                                const progress = (player.currentTime / player.duration * 100).toFixed(2);
                                setLabelText(`moving - ${progress}% (${Math.round((player.currentTime - startvideoposition))}s)`);
                            }
                        }, 500);
                    }

                    positionscrollcurr = positionscroll - positionscrollstart;
                    
                    
                }
            });

            if(path != null)
            {
                console.log(`path - ${path}`);
                player = document.getElementById("player");
                player.src = path;

                player.play();
                player.volume = 0.1;
                window.addEventListener("keydown", onKeydown);
            }
            else
            {
                console.log(`${path} is null`);
            }

        </script>

    </body>
</html>