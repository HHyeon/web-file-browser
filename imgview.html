<html>
    <head>
        <meta charset="utf-8">
        <title>imgviewer</title>

        <style>
            * {
                margin: 0px;
            }

            body {
                background-color: rgb(25, 25, 25);
                color: aliceblue;
                overflow-y: hidden; /* Hide vertical scrollbar */
                overflow-x: hidden; /* Hide horizontal scrollbar */
                text-align: center;
            }

            .imageview {
                position:relative;
                width: 100%;
                height: 100%;
            }

            .imageview img {
                object-fit: contain;
                object-position: 50% 50%;
                width: 100%;
                height: 100%;
            }

            .imageview h6 {
                background-color: rgba(0, 0, 0, 0.2);
                position: absolute;
                top: 0;
                word-wrap: break-word;
                word-break: break-all;
            }

            .grid_temp {
                width: 100%;
                height: 100%;
                
                /* height: fit-content;
                display: grid;
                grid-auto-rows: 1fr;
                grid-template-columns: repeat(5, 20%);
                grid-template-rows: 1fr; */
            }

            
            .label1 {
                position:fixed;
                left: 2%;
                top: 2%;
                background-color: rgba(0, 0, 0, 0.2);
            }

        </style>
    </head>
    <body>


    <div class="grid_temp">
        <div class="imageview">
            <img></img>
            <h6></h6>
        </div>
    </div>

    <h1 class="label1"></h1>

    <script>
        
        const label1 = document.querySelector(".label1");
        let delayedoffTimer = undefined;
        
        function setLabelText(msg) {
            if(delayedoffTimer != undefined) clearTimeout(delayedoffTimer);
            
            label1.innerText = msg;
            label1.style.visibility="visible";
            
            delayedoffTimer = setTimeout(() => {
                label1.style.visibility="hidden";
                delayedoffTimer = undefined;
            },1000);

        }
        

        function dirseek(param) {
            let xmlhttp = new XMLHttpRequest();
            let url=`dirseek.php?x=${param}`;
            xmlhttp.open("GET", url, false);
            xmlhttp.send(null);
            return xmlhttp.responseText;
        };

        function extractlastnumberfromfilename(str) {
            let dotpos = str.lastIndexOf('.');
            if(dotpos == -1) return -1;
            let src1 = str.substring(0, dotpos);

            if(isNaN(src1))
            {
                let cut=-1;
                for(let i=src1.length-1;i>=0;i--)
                {
                    if(isNaN(src1[i]))
                    {
                        cut = i+1;
                        break;
                    }
                }
            
                if(cut == -1) return -1;
                let res = src1.substring(cut);
                return Number(res);
            }
            else 
            {
                console.log(`Number`);
                return Number(src1);
            }   

        }

        const urlStr = window.location.href;
        const url = new URL(urlStr);
        const urlParams = url.searchParams;
        const parampath = urlParams.get('p');
        const paramname = urlParams.get('t');
        let imagelayers = document.querySelector('.imageview');
        let filelist_index=0;
        let filelist;
        let image_top = document.querySelector('img');
        
        function image_nav_next()
        {
            if(filelist_index < filelist.length-2) filelist_index++;

            imagelayers.children[0].src = `${parampath}/${filelist[filelist_index]["d"]}`;
            imagelayers.children[1].innerText = filelist[filelist_index]["d"];
        }

        function image_nav_prev()
        {
            if(filelist_index > 0) filelist_index--;

            imagelayers.children[0].src = `${parampath}/${filelist[filelist_index]["d"]}`;
            imagelayers.children[1].innerText = filelist[filelist_index]["d"];
        }

        document.addEventListener("keydown", (param) => {
            console.log(param.key)

            switch(param.key)
            {
                case 'ArrowLeft':
                    image_nav_prev();
                    break;
                case ' ':
                case 'ArrowRight':
                    image_nav_next();
                    break;

                case '.':
                    if(image_top.style.objectFit == 'contain')
                    {
                        setLabelText("Fit To Window");
                        image_top.style.objectFit='cover';
                    }
                    else
                    {
                        setLabelText("Fit To Video");
                        image_top.style.objectFit='contain';
                    }

                    break;
                case 'f':
                case 'Enter':
                    {
                        if (!document.fullscreenElement) {
                            document.documentElement.requestFullscreen()
                        } else {
                            if (document.exitFullscreen)
                                document.exitFullscreen()
                        }
                    }
                    break;
            }
        });

        let img_width = -1;
        let img_height = -1;
        image_top.addEventListener("load", () => {
            img_width = image_top.naturalWidth;
            img_height = image_top.naturalHeight;
            // image_top.style.objectPosition = `-${img_width/4}px -${img_height/4}px`;
            console.log(`${img_width}, ${img_height}`);
        });

        let mousebuttondowned = false;

        document.addEventListener("mousedown", (param) => {
            if(event.preventDefault)
                event.preventDefault();
            else
                event.returnValue = false;

            if(param.button == 0)
            {
                console.log("mousedown");
                mousebuttondowned = true;
            }
        });
        
        document.addEventListener("mouseup", (param) => {
            
            if(param.button == 0)
            {
                console.log("mouseup");
                mousebuttondowned = false;
            }

        });
        
        document.addEventListener("mousemove", (param) => {
            
            if(mousebuttondowned)
            {
                console.log("mousemove");
            }

        });

        console.log(`parampath - ${parampath}`);
        console.log(`paramname - ${paramname}`);

        if(parampath != null && paramname != null)
        {
            const jsondata=JSON.parse(dirseek(parampath));

            if(jsondata['ret'])
            {
                filelist = jsondata['data'];
                
                filelist.sort((a,b) => {
                    return extractlastnumberfromfilename(a["d"]) - extractlastnumberfromfilename(b["d"]);
                });

                filelist_index = filelist.indexOf(filelist.find(a => a["d"] == paramname));

                imagelayers.children[0].src = `${parampath}/${filelist[filelist_index]["d"]}`;
                imagelayers.children[1].innerText = filelist[filelist_index]["d"];
                
            }
            else
            {
                // Fail
            }
        }
        else
        {

        }

    </script>


    </body>
</html>