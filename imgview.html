<html>
    <head>
        <meta charset="utf-8">
        <title>imgviewer</title>

        <style>
            * {
                margin: 0px;
            }

            body {
                background-color: rgb(25, 25, 25);
                color: aliceblue;
                overflow-y: hidden; /* Hide vertical scrollbar */
                overflow-x: hidden; /* Hide horizontal scrollbar */
                text-align: center;
            }

            .imageview {
                position:relative;
                width: 98%;
                height: 98%;
            }

            .imageview img {
                object-fit: contain;
                object-position: center;
                width: 100%;
                height: 100%;
            }

            .imageview h6 {
                background-color: rgba(0, 0, 0, 0.2);
                position: absolute;
                top: 0;
                word-wrap: break-word;
                word-break: break-all;
            }

            .grid_temp {
                width: 100%;
                height: 100%;
                
                height: fit-content;
                display: grid;
                grid-auto-rows: 1fr;
                grid-template-columns: repeat(5, 20%);
                grid-template-rows: 1fr;
            }

        </style>
    </head>
    <body>

    <div class="grid_temp"></div>

    <script>

        const img_object_count = 5;

        for(let i=0;i<img_object_count;i++) {
            document.querySelector('.grid_temp').innerHTML += `
            <div class="imageview">
                <img></img>
                <h6></h6>
            </div>
            `;
        }

        function dirseek(param) {
            let xmlhttp = new XMLHttpRequest();
            let url=`dirseek.php?x=${param}`;
            xmlhttp.open("GET", url, false);
            xmlhttp.send(null);
            return xmlhttp.responseText;
        };

        function extractlastnumberfromfilename(str) {
            let dotpos = str.lastIndexOf('.');
            if(dotpos == -1) return -1;
            let src1 = str.substring(0, dotpos);

            if(Number(src1) == NaN)
            {
                let cut=-1;
                for(let i=src1.length-1;i>=0;i--)
                {
                    if(!(src1[i] >= '0' && src1[i] <= '9'))
                    {
                        cut = i+1;
                        break;
                    }
                }
            
                if(cut == -1) return -1;
                let res = src1.substring(cut);
                return Number(res);
            }
            else 
            {
                return Number(src1);
            }   

        }

        const urlStr = window.location.href;
        const url = new URL(urlStr);
        const urlParams = url.searchParams;
        const parampath = urlParams.get('p');
        const paramname = urlParams.get('t');
        let imagelayers = document.querySelectorAll('.imageview');
        let filelist;
        let filelist_index_tail = 10;
        let filelist_index_head = 5;

        imagelayers.forEach(element => {

        });

        let image_index_field = [];

        let showingimageindex = Number(filelist_index_tail/filelist_index_head);
        let showingimageindex_past = showingimageindex;
        function image_nav_next()
        {
            if(filelist_index_tail == filelist.length) return;

            imagelayers[showingimageindex_past].style.border = '';
            // imagelayers[showingimageindex_past].style.display = 'none';

            // replace minimum index of image
            let replace_image_index = image_index_field.indexOf(Math.min(...image_index_field));
            imagelayers[replace_image_index].children[0].src = `${parampath}/${filelist[filelist_index_tail]["d"]}`;
            imagelayers[replace_image_index].children[1].innerText = filelist[filelist_index_tail]["d"];
            image_index_field[replace_image_index] = filelist_index_tail;
            filelist_index_head++;
            filelist_index_tail++;

            // console.log(`image_index_field - ${image_index_field}`);
            // console.log(`filelist_index_head - ${filelist_index_head} , filelist_index_tail - ${filelist_index_tail}`);
            
            showingimageindex++;
            if(showingimageindex >= img_object_count) showingimageindex = 0;
            imagelayers[showingimageindex].style.border = 'solid lightgray';
            // imagelayers[showingimageindex].style.display = '';
            showingimageindex_past = showingimageindex;
        }

        function image_nav_prev()
        {
            if(filelist_index_head == 0) return;

            imagelayers[showingimageindex_past].style.border = '';
            // imagelayers[showingimageindex_past].style.display = 'none';
            
            filelist_index_head--;
            filelist_index_tail--;

            // replace minimum index of image
            let replace_image_index = image_index_field.indexOf(Math.max(...image_index_field));
            imagelayers[replace_image_index].children[0].src = `${parampath}/${filelist[filelist_index_head]["d"]}`;
            imagelayers[replace_image_index].children[1].innerText = filelist[filelist_index_head]["d"];
            image_index_field[replace_image_index] = filelist_index_head;

            // console.log(`image_index_field - ${image_index_field}`);
            // console.log(`filelist_index_head - ${filelist_index_head} , filelist_index_tail - ${filelist_index_tail}`);
            
            showingimageindex--;
            if(showingimageindex == -1) showingimageindex = img_object_count-1;
            imagelayers[showingimageindex].style.border = 'solid lightgray';
            // imagelayers[showingimageindex].style.display = '';
            showingimageindex_past = showingimageindex;
        }

        document.addEventListener("keydown", (param) => {
            console.log(param.key)

            switch(param.key)
            {
                case 'ArrowLeft':
                    image_nav_prev();
                    break;
                case 'ArrowRight':
                    image_nav_next();
                    break;
            }
        });

        console.log(`parampath - ${parampath}`);
        console.log(`paramname - ${paramname}`);

        if(parampath != null && paramname != null)
        {
            const jsondata=JSON.parse(dirseek(parampath));

            if(jsondata['ret'])
            {
                filelist = jsondata['data'];
                
                filelist.sort((a,b) => {
                    return extractlastnumberfromfilename(a["d"]) - extractlastnumberfromfilename(b["d"]);
                });
                
                for(let i=0;i<imagelayers.length;i++)
                {
                    imagelayers[i].children[0].src = `${parampath}/${filelist[filelist_index_head+i]["d"]}`;
                    imagelayers[i].children[1].innerText = filelist[filelist_index_head+i]["d"];
                    // imagelayers[i].style.display = 'none';
                    imagelayers[i].style.zIndex = 0;
                    image_index_field.push(filelist_index_head+i);
                }

                imagelayers[showingimageindex].style.border = 'solid lightgray';
                // imagelayers[showingimageindex].style.display = '';
                imagelayers[showingimageindex].style.zIndex = 1;
            }
            else
            {
                // Fail
            }
        }
        else
        {

        }

    </script>


    </body>
</html>